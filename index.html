<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>consoIDE Pro - Full File Manager</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

<style>
/* 1. BASE Y RESET */
* { touch-action: manipulation; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; -webkit-user-select: none; }
textarea, pre, input { user-select: text !important; -webkit-user-select: text !important; }
body { margin:0; font-family: monospace; background:#0b0b0b; color:#ddd; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
header { padding:10px; background:#111; border-bottom:1px solid #222; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
button, select, input { background:#222; color:#ddd; border:1px solid #333; padding:8px; font-size: 14px !important; border-radius: 4px; outline: none; }

/* 2. EXPLORADOR Y MEN√ö CONTEXTUAL */
.main-wrapper { display: flex; flex-direction: column; flex: 1; overflow: hidden; }
.top-section { display: flex; height: 50%; border-bottom: 2px solid #333; }
#explorer-container { width: 30%; border-right: 1px solid #222; display: flex; flex-direction: column; background: #0d0d0d; }
#explorer { flex: 1; overflow-y: auto; padding: 5px; position: relative; }

.grid-mode { display: flex !important; flex-wrap: wrap; gap: 10px; padding: 10px; align-content: flex-start; }
.grid-mode .file-item { flex-direction: column; text-align: center; width: 75px; border: none !important; }
.grid-mode .file-item span { font-size: 28px; display: block; }
.file-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #1a1a1a; cursor: pointer; gap: 8px; }

/* Men√∫ Contextual Flotante */
#context-menu { position: fixed; background: #1a1a1a; border: 1px solid #444; box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 1000; display: none; min-width: 150px; border-radius: 4px; }
#context-menu div { padding: 12px 15px; border-bottom: 1px solid #333; cursor: pointer; font-size: 14px; }
#context-menu div:last-child { border: none; }
#context-menu div:active { background: #333; }

/* 3. EDITOR E INPUT */
#main-editor { width: 40%; padding: 8px; display: flex; flex-direction: column; border-right: 1px solid #222; overflow: hidden; }
.input-group { display: flex; width: 100%; gap: 4px; margin-bottom: 5px; flex-shrink: 0; }
#input-line { flex: 1; background: #111; color: #0f0; border: 1px solid #444; }

#editor-viewport { position: relative; flex: 1; display: flex; background: #000; border: 1px solid #222; overflow: hidden; }
#line-numbers { width: 35px; background: #151515; color: #555; border-right: 1px solid #222; position: relative; overflow: hidden; flex-shrink: 0; }
.ln-num { position: absolute; right: 5px; width: 100%; text-align: right; font-family: 'Courier New', monospace; }

#code-wrapper { position: relative; flex: 1; overflow: hidden; }
#code-ghost { position: absolute; visibility: hidden; pointer-events: none; white-space: pre-wrap; word-wrap: break-word; width: 100%; font-family: 'Courier New', monospace !important; padding: 10px; }
#code { width: 100%; height: 100%; background: transparent; color: #cfe; border: none; padding: 10px; resize: none; font-family: 'Courier New', monospace !important; z-index: 2; position: relative; white-space: pre-wrap; word-wrap: break-word; overflow-y: auto; outline: none; }

#error-highlight { position: absolute; top: 0; left: 0; right: 0; pointer-events: none; z-index: 1; }
.error-line { position: absolute; left: 0; right: 0; background: rgba(255, 0, 0, 0.3); border-bottom: 2px solid #ff4444; }

/* 4. CONSOLA Y GR√ÅFICO */
#console-panel { width: 30%; display: flex; flex-direction: column; background: #050505; }
#output { background: #000; color: #cfe; padding: 10px; flex: 1; overflow: auto; margin: 0; white-space: pre-wrap; font-size: 13px; }
.solution-box { color: #f90; font-weight: bold; margin-top: 10px; padding: 8px; border: 1px dashed #444; background: rgba(255,153,0,0.1); }

#visual-panel { height: 50%; background: #fff; display: block; }
#visual-box { width: 100%; height: 100%; border: none; }
.panel-label { padding: 4px 8px; background: #222; font-size: 10px; color: #888; text-transform: uppercase; display: flex; justify-content: space-between; align-items: center; }
</style>
</head>

<body onclick="hideContext()">

<header>
    <button onclick="goBack()">‚¨Ö</button>
    <button onclick="toggleExplorerMode()">üîÑ Vista</button>
    <button onclick="showCreateMenu()" style="background:#224;">‚ûï Nuevo</button>
    <button onclick="toggleVisual()" style="background:#333;">üñºÔ∏è Gr√°fico</button>
    <button onclick="resetPath()">üè†</button>
    <select id="explorerFontSelect" onchange="changeExpFont(this.value)"></select>
    <select id="editorFontSelect" onchange="changeEdFont(this.value)"></select>
</header>

<div id="context-menu"></div>

<div class="main-wrapper">
    <div class="top-section" id="top-section">
        <div id="explorer-container">
            <div class="panel-label">Explorador</div>
            <div id="explorer"></div>
        </div>

        <div id="main-editor">
            <div class="input-group">
                <input type="text" id="input-line" placeholder="Input para script...">
                <button onclick="sendInput()">Enviar</button>
            </div>
            <div style="display:flex; gap:4px; margin-bottom:5px;">
                <button onclick="runCode()" style="background: #1a4d1a; flex:1;">‚ñ∂ Ejecutar</button>
                <button onclick="saveFile()">üíæ</button>
                <button onclick="clearEditor()">üßΩ</button>
            </div>
            <div id="editor-viewport">
                <div id="line-numbers"></div>
                <div id="code-wrapper">
                    <div id="code-ghost"></div>
                    <div id="error-highlight"></div>
                    <textarea id="code" spellcheck="false" oninput="updateLines()" onscroll="syncScroll()"></textarea>
                </div>
            </div>
        </div>

        <div id="console-panel">
            <div class="panel-label">Salida <button onclick="clearOutput()" style="background:none; border:none; color:red;">üßπ Limpiar</button></div>
            <div id="output"></div>
        </div>
    </div>
    
    <div id="visual-panel">
        <div class="panel-label">Vista Gr√°fica</div>
        <iframe id="visual-box"></iframe>
    </div>
</div>

<script>
const elCode = document.getElementById('code'), elGhost = document.getElementById('code-ghost'), elLines = document.getElementById('line-numbers'),
      elErrorBox = document.getElementById('error-highlight'), elOutput = document.getElementById('output'), elExplorer = document.getElementById('explorer'),
      elVisual = document.getElementById('visual-box'), elInput = document.getElementById('input-line'), elCtx = document.getElementById('context-menu');

let state = { path: localStorage.getItem('path') || '/sdcard', file: null, fExp: localStorage.getItem('fExp') || '14', fEd: localStorage.getItem('fEd') || '14', isGrid: false, clipboard: null };

// --- GESTI√ìN DE ARCHIVOS ---
function setupLongPress(element, fileObj) {
    let timer;
    element.addEventListener('touchstart', (e) => {
        timer = setTimeout(() => showContext(e.touches[0].clientX, e.touches[0].clientY, fileObj), 600);
    });
    element.addEventListener('touchend', () => clearTimeout(timer));
}

function showContext(x, y, file) {
    elCtx.style.display = 'block';
    elCtx.style.left = x + 'px'; elCtx.style.top = y + 'px';
    elCtx.innerHTML = `
        <div onclick="fm_rename('${file.path}')">‚úèÔ∏è Renombrar</div>
        <div onclick="fm_copy('${file.path}')">üìã Copiar</div>
        <div onclick="fm_move('${file.path}')">‚úÇÔ∏è Mover</div>
        <div onclick="fm_delete('${file.path}')" style="color:red">üóëÔ∏è Eliminar</div>
        <div onclick="fm_props('${file.path}')">‚ÑπÔ∏è Propiedades</div>
    `;
    if(state.clipboard) elCtx.innerHTML += `<div onclick="fm_paste()" style="background:#224">üì• Pegar aqu√≠</div>`;
}

function hideContext() { elCtx.style.display = 'none'; }

async function showCreateMenu() {
    const name = prompt("Nombre del nuevo archivo o carpeta:");
    if(!name) return;
    const type = confirm("¬øEs una carpeta? (Cancelar para Archivo)") ? 'dir' : 'file';
    await fetch('/api/create', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ path: state.path + '/' + name, type }) });
    loadDir();
}

async function fm_delete(p) { if(confirm("¬øEliminar?")) { await fetch('/api/delete?path=' + encodeURIComponent(p)); loadDir(); } }
async function fm_rename(p) { 
    const n = prompt("Nuevo nombre:", p.split('/').pop());
    if(n) { await fetch('/api/rename', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ old: p, new: state.path+'/'+n })}); loadDir(); }
}
function fm_copy(p) { state.clipboard = { action: 'copy', path: p }; alert("Copiado al portapapeles"); }
function fm_move(p) { state.clipboard = { action: 'move', path: p }; alert("Listo para mover"); }
async function fm_paste() {
    await fetch('/api/paste', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ ...state.clipboard, dest: state.path }) });
    state.clipboard = null; loadDir();
}
async function fm_props(p) { 
    const res = await fetch('/api/props?path=' + encodeURIComponent(p));
    const data = await res.json();
    alert(`Ruta: ${data.path}\nTama√±o: ${data.size}\nModificado: ${data.mtime}`);
}

// --- N√öMEROS Y FUENTES ---
function updateLines() {
    const lines = elCode.value.split('\n');
    let numbersHTML = '';
    const fontSize = parseInt(state.fEd);
    const lineHeight = fontSize * 1.4;
    elCode.style.lineHeight = lineHeight + 'px'; elGhost.style.lineHeight = lineHeight + 'px';
    elGhost.style.width = elCode.clientWidth + 'px'; elGhost.innerHTML = '';
    let topPos = 10; 
    lines.forEach((txt, i) => {
        const span = document.createElement('span');
        span.style.display = 'block'; span.textContent = txt || ' '; elGhost.appendChild(span);
        numbersHTML += `<div class="ln-num" style="top:${topPos}px; font-size:${fontSize}px; height:${span.offsetHeight}px;">${i+1}</div>`;
        topPos += span.offsetHeight;
    });
    elLines.innerHTML = numbersHTML; syncScroll();
}

function syncScroll() { elLines.style.top = `-${elCode.scrollTop}px`; elErrorBox.style.top = `-${elCode.scrollTop}px`; }

// --- EXPLORADOR Y APERTURA ---
async function loadDir() {
    try {
        const res = await fetch('/api/list?path=' + encodeURIComponent(state.path));
        const files = await res.json();
        elExplorer.innerHTML = '';
        files.sort((a,b) => (a.type === b.type ? a.name.localeCompare(b.name) : a.type === 'dir' ? -1 : 1)).forEach(f => {
            const div = document.createElement('div');
            div.className = 'file-item';
            div.innerHTML = `<span>${f.type === 'dir' ? 'üìÅ' : 'üìÑ'}</span> <div>${f.name}</div>`;
            div.onclick = () => f.type === 'dir' ? (state.path = f.path, localStorage.setItem('path', state.path), loadDir()) : openFile(f.path);
            setupLongPress(div, f);
            elExplorer.appendChild(div);
        });
    } catch(e) {}
}

async function openFile(p) {
    const res = await fetch('/api/open?file=' + encodeURIComponent(p));
    const content = await res.text();
    elCode.value = content; state.file = p;
    if(p.endsWith('.html')) elVisual.srcdoc = content;
    updateLines();
}

async function runCode() {
    const code = elCode.value; if(!code.trim()) return;
    if(state.file && state.file.endsWith('.html')) { elVisual.srcdoc = code; elOutput.innerHTML = "Gr√°fico actualizado."; return; }
    elOutput.innerHTML = "Ejecutando...\n";
    try {
        await fetch('/api/save', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ file: state.file || '/sdcard/pru.py', content: code }) });
        const res = await fetch('/api/run', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ file: state.file || '/sdcard/pru.py' }) });
        const result = await res.text();
        elOutput.innerHTML = `<pre style="color:#cfe;">${result}</pre>`;
        const m = result.match(/line (\d+)/i);
        if(m) markError(parseInt(m[1]));
    } catch(e) {}
}

function markError(n) {
    const t = elLines.querySelectorAll('.ln-num')[n-1];
    if(t) { elErrorBox.innerHTML = `<div class="error-line" style="top:${t.style.top}; height:${t.offsetHeight}px"></div>`; }
}

// --- UI HELPERS ---
function initFonts() {
    const sExp = document.getElementById('explorerFontSelect'), sEd = document.getElementById('editorFontSelect');
    for(let i=10; i<=30; i++) { sExp.add(new Option(`Exp: ${i}px`, i)); sEd.add(new Option(`Ed: ${i}px`, i)); }
    sExp.value = state.fExp; sEd.value = state.fEd;
    changeExpFont(state.fExp); changeEdFont(state.fEd);
}
function changeExpFont(v) { elExplorer.style.fontSize = v + 'px'; state.fExp = v; localStorage.setItem('fExp', v); }
function changeEdFont(v) { elCode.style.fontSize = v + 'px'; state.fEd = v; localStorage.setItem('fEd', v); updateLines(); }
function clearEditor() { elCode.value = ''; updateLines(); }
function clearOutput() { elOutput.innerHTML = ''; elErrorBox.innerHTML = ''; }
function sendInput() { elOutput.innerHTML += `>> ${elInput.value}\n`; elInput.value = ''; }
function toggleExplorerMode() { state.isGrid = !state.isGrid; elExplorer.classList.toggle('grid-mode', state.isGrid); loadDir(); }
function toggleVisual() { 
    const v = document.getElementById('visual-panel');
    v.style.display = v.style.display === 'none' ? 'block' : 'none';
    document.getElementById('top-section').style.height = v.style.display === 'none' ? '100%' : '50%';
}
function resetPath() { state.path = '/sdcard'; loadDir(); }
function goBack() { let p = state.path.split('/'); if(p.length > 2) { p.pop(); state.path = p.join('/'); loadDir(); } }

initFonts(); loadDir();
new ResizeObserver(updateLines).observe(elCode);
</script>
</body>
</html>
