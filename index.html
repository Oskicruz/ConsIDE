<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>consoIDE Pro - Funcionalidad Restaurada</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

<style>
/* 1. BASE Y RESET (Mantenido igual) */
* { touch-action: manipulation; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; -webkit-user-select: none; }
textarea, pre, input { user-select: text !important; -webkit-user-select: text !important; }
body { margin:0; font-family: monospace; background:#0b0b0b; color:#ddd; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

/* HEADER */
header { padding:10px; background:#111; border-bottom:1px solid #222; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
.header-right { margin-left: auto; display: flex; gap: 8px; }
button, select, input { background:#222; color:#ddd; border:1px solid #333; padding:8px; font-size: 14px !important; border-radius: 4px; outline: none; cursor: pointer; }

/* 2. ESTRUCTURA PRINCIPAL */
.main-wrapper { display: flex; flex-direction: column; flex: 1; overflow: hidden; }
.top-section { display: flex; height: 50%; border-bottom: 2px solid #333; }

/* EXPLORADOR */
#explorer-container { width: 30%; border-right: 1px solid #222; display: flex; flex-direction: column; background: #0d0d0d; }
#explorer { flex: 1; overflow-y: auto; padding: 5px; position: relative; }
.explorer-controls { padding: 8px; border-top: 1px solid #222; }

/* MODO ICONOS */
.grid-mode { display: flex !important; flex-wrap: wrap; gap: 10px; padding: 10px; align-content: flex-start; }
.grid-mode .file-item { flex-direction: column; text-align: center; width: 75px; border: none !important; }
.grid-mode .file-item span { font-size: 28px; display: block; }
.file-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #1a1a1a; cursor: pointer; gap: 8px; }

/* EDITOR */
#main-editor { width: 40%; padding: 8px; display: flex; flex-direction: column; border-right: 1px solid #222; overflow: hidden; }
#editor-viewport { position: relative; flex: 1; display: flex; background: #000; border: 1px solid #222; overflow: hidden; }
#line-numbers { width: 35px; background: #151515; color: #555; border-right: 1px solid #222; position: relative; overflow: hidden; flex-shrink: 0; }
.ln-num { position: absolute; right: 5px; width: 100%; text-align: right; font-family: 'Courier New', monospace; }

#code-wrapper { position: relative; flex: 1; overflow: hidden; }
#code { width: 100%; height: 100%; background: transparent; color: #cfe; border: none; padding: 10px; resize: none; font-family: 'Courier New', monospace !important; z-index: 2; position: relative; white-space: pre-wrap; word-wrap: break-word; overflow-y: auto; outline: none; }

/* CONTROLES EDITOR */
.editor-controls { display: flex; flex-direction: column; gap: 5px; margin-top: 8px; }
.input-group { display: flex; gap: 4px; }
#input-line { flex: 1; background: #111; color: #0f0; border: 1px solid #444; }

/* CONSOLA */
#console-panel { width: 30%; display: flex; flex-direction: column; background: #050505; }
#output { background: #000; color: #cfe; padding: 10px; flex: 1; overflow: auto; margin: 0; white-space: pre-wrap; font-size: 13px; }
.console-controls { padding: 8px; border-top: 1px solid #222; }

/* MEN√ö CONTEXTUAL */
#context-menu { position: fixed; background: #1f1f1f; border: 1px solid #444; z-index: 1000; display: none; min-width: 160px; border-radius: 6px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
#context-menu div { padding: 12px 15px; border-bottom: 1px solid #333; cursor: pointer; font-size: 14px; }
#context-menu div:last-child { border-bottom: none; }
#context-menu div:hover { background: #333; }

#visual-panel { height: 50%; background: #fff; display: block; }
#visual-box { width: 100%; height: 100%; border: none; background: white; }
.panel-label { padding: 4px 8px; background: #222; font-size: 10px; color: #888; text-transform: uppercase; }
</style>
</head>

<body onclick="hideContext()">

<header>
    <button onclick="goBack()">‚¨Ö</button>
    <button onclick="toggleExplorerMode()">üîÑ Vista</button>
    <button onclick="createFile()" style="background:#1a3a5a;">üìÑ+ Archivo</button>
    <button onclick="createFolder()" style="background:#1a5a3a;">üìÅ+ Carpeta</button>
    <button onclick="subirAGitHub()" style="background:#24292e; color:white;">üêô GitHub</button>
    <button onclick="toggleVisual()" style="background:#333;">üñºÔ∏è Gr√°fico</button>
    <button onclick="resetPath()">üè†</button>
    
    <div class="header-right">
        <select id="explorerFontSelect" onchange="changeExpFont(this.value)"></select>
        <select id="editorFontSelect" onchange="changeEdFont(this.value)"></select>
        <button onclick="saveFile()" style="background: #a52a2a; font-weight: bold;">üíæ GUARDAR</button>
    </div>
</header>

<div id="context-menu"></div>

<div class="main-wrapper">
    <div class="top-section" id="top-section">
        <div id="explorer-container">
            <div class="panel-label">Explorador</div>
            <div id="explorer"></div>
            <div class="explorer-controls">
                <button onclick="loadDir()" style="width:100%; color:#0f0; border-color:#0f0;">üîÑ Actualizar</button>
            </div>
        </div>

        <div id="main-editor">
            <div class="panel-label">Editor</div>
            <div id="editor-viewport">
                <div id="line-numbers"></div>
                <div id="code-wrapper">
                    <textarea id="code" spellcheck="false" oninput="updateLines()" onscroll="syncScroll()"></textarea>
                </div>
            </div>
            
            <div class="editor-controls">
                <div class="input-group">
                    <input type="text" id="input-line" placeholder="Input para script...">
                    <button onclick="sendInput()">Enviar</button>
                </div>
                <div style="display:flex; gap:4px;">
                    <button onclick="runCode()" style="background: #1a4d1a; flex:1;">‚ñ∂ Ejecutar</button>
                    <button onclick="clearEditor()" style="flex:0.4;">üßΩ Limpiar</button>
                </div>
            </div>
        </div>

        <div id="console-panel">
            <div class="panel-label">Salida</div>
            <div id="output"></div>
            <div class="console-controls">
                <button onclick="clearAll()" style="color:#ff4444; width:100%;">üßπ Limpiar Todo</button>
            </div>
        </div>
    </div>
    
    <div id="visual-panel">
        <div class="panel-label">Vista Gr√°fica</div>
        <iframe id="visual-box"></iframe>
    </div>
</div>

<script>
// --- VARIABLES GLOBALES ---
const elCode = document.getElementById('code'), elLines = document.getElementById('line-numbers'),
      elOutput = document.getElementById('output'), elExplorer = document.getElementById('explorer'),
      elVisual = document.getElementById('visual-box'), elInput = document.getElementById('input-line'), elCtx = document.getElementById('context-menu');

let state = { 
    path: localStorage.getItem('path') || '/sdcard', 
    file: null, 
    fExp: localStorage.getItem('fExp') || '14', 
    fEd: localStorage.getItem('fEd') || '14', 
    isGrid: false, 
    clipboard: null 
};

// --- GESTI√ìN DE ARCHIVOS (REPARADA) ---

async function loadDir() {
    try {
        const res = await fetch('/api/list?path=' + encodeURIComponent(state.path));
        const files = await res.json();
        elExplorer.innerHTML = '';
        files.sort((a,b) => (a.type === b.type ? a.name.localeCompare(b.name) : a.type === 'dir' ? -1 : 1)).forEach(f => {
            const div = document.createElement('div');
            div.className = 'file-item';
            div.innerHTML = `<span>${f.type === 'dir' ? 'üìÅ' : 'üìÑ'}</span> <div>${f.name}</div>`;
            div.onclick = () => f.type === 'dir' ? changeDir(f.path) : openFile(f.path);
            
            // Eventos para men√∫ contextual (Clic derecho y Long Press)
            div.oncontextmenu = (e) => { e.preventDefault(); showContext(e.clientX, e.clientY, f); };
            setupLongPress(div, f);
            
            elExplorer.appendChild(div);
        });
    } catch(e) { elOutput.innerHTML += "Error al listar directorio.\n"; }
}

function changeDir(newPath) {
    state.path = newPath;
    localStorage.setItem('path', state.path);
    loadDir();
}

async function createFile() {
    const name = prompt("Nombre del archivo en: " + state.path);
    if(!name) return;
    const fullPath = state.path + (state.path.endsWith('/') ? '' : '/') + name;
    await fetch('/api/create', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ path: fullPath, type: 'file' })});
    loadDir();
}

async function createFolder() {
    const name = prompt("Nombre de la carpeta en: " + state.path);
    if(!name) return;
    const fullPath = state.path + (state.path.endsWith('/') ? '' : '/') + name;
    await fetch('/api/create', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ path: fullPath, type: 'dir' })});
    loadDir();
}

// --- FUNCIONES DEL MEN√ö CONTEXTUAL (REINSTALADAS) ---

function showContext(x, y, file) {
    elCtx.style.display = 'block';
    elCtx.style.left = x + 'px'; elCtx.style.top = y + 'px';
    elCtx.innerHTML = `
        <div onclick="fm_rename('${file.path}')">‚úèÔ∏è Renombrar</div>
        <div onclick="fm_copy('${file.path}')">üìã Copiar</div>
        <div onclick="fm_delete('${file.path}')" style="color:#ff6666">üóëÔ∏è Eliminar</div>
        <div onclick="fm_info('${file.path}')">‚ÑπÔ∏è Propiedades</div>
    `;
    if(state.clipboard) elCtx.innerHTML += `<div onclick="fm_paste()" style="background:#1a3a5a">üì• Pegar aqu√≠</div>`;
}

async function fm_delete(p) {
    if(!confirm("¬øEliminar definitivamente?")) return;
    await fetch('/api/delete', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ path: p })});
    loadDir();
}

async function fm_rename(p) {
    const newName = prompt("Nuevo nombre:");
    if(!newName) return;
    await fetch('/api/rename', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ path: p, newName: newName })});
    loadDir();
}

function fm_copy(p) { state.clipboard = p; alert("Copiado al portapapeles"); }

async function fm_paste() {
    if(!state.clipboard) return;
    await fetch('/api/paste', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ source: state.clipboard, targetDir: state.path })});
    loadDir();
}

function fm_info(p) {
    alert("Ruta: " + p + "\nUbicaci√≥n actual: " + state.path);
}

// --- UTILIDADES ---
function setupLongPress(element, fileObj) {
    let timer;
    element.addEventListener('touchstart', (e) => {
        timer = setTimeout(() => showContext(e.touches[0].clientX, e.touches[0].clientY, fileObj), 600);
    });
    element.addEventListener('touchend', () => clearTimeout(timer));
}

function hideContext() { elCtx.style.display = 'none'; }

async function openFile(p) {
    const res = await fetch('/api/open?file=' + encodeURIComponent(p));
    const content = await res.text();
    elCode.value = content; state.file = p;
    if(p.endsWith('.html')) elVisual.srcdoc = content;
    updateLines();
}

async function saveFile() {
    if(!state.file) return alert("Abre un archivo primero");
    await fetch('/api/save', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ file: state.file, content: elCode.value }) });
    elOutput.innerHTML = "‚úÖ Guardado: " + state.file + "\n" + elOutput.innerHTML;
}

async function runCode() {
    if(!elCode.value.trim()) return;
    elOutput.innerHTML = "Ejecutando...\n";
    try {
        await saveFile();
        const res = await fetch('/api/run', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ file: state.file }) });
        elOutput.innerHTML += await res.text();
    } catch(e) { elOutput.innerHTML += "Error de ejecuci√≥n.\n"; }
}

function updateLines() {
    const lines = elCode.value.split('\n');
    let numbersHTML = '';
    lines.forEach((_, i) => numbersHTML += `<div>${i+1}</div>`);
    elLines.innerHTML = numbersHTML;
    syncScroll();
}

function syncScroll() { elLines.scrollTop = elCode.scrollTop; }
function clearAll() { elOutput.innerHTML = ''; elVisual.srcdoc = ''; }
function clearEditor() { elCode.value = ''; updateLines(); }
function sendInput() { elOutput.innerHTML += ">> " + elInput.value + "\n"; elInput.value = ''; }
function resetPath() { state.path = '/sdcard'; loadDir(); }
function goBack() { 
    let parts = state.path.split('/');
    if(parts.length > 2) { parts.pop(); changeDir(parts.join('/') || '/'); }
}
function toggleExplorerMode() { state.isGrid = !state.isGrid; elExplorer.classList.toggle('grid-mode', state.isGrid); loadDir(); }

function initFonts() {
    const sExp = document.getElementById('explorerFontSelect'), sEd = document.getElementById('editorFontSelect');
    for(let i=10; i<=30; i++) { sExp.add(new Option(i + "px", i)); sEd.add(new Option(i + "px", i)); }
    sExp.value = state.fExp; sEd.value = state.fEd;
    changeExpFont(state.fExp); changeEdFont(state.fEd);
}
function changeExpFont(v) { elExplorer.style.fontSize = v + 'px'; state.fExp = v; localStorage.setItem('fExp', v); }
function changeEdFont(v) { elCode.style.fontSize = v + 'px'; state.fEd = v; localStorage.setItem('fEd', v); updateLines(); }

function toggleVisual() { 
    const v = document.getElementById('visual-panel');
    v.style.display = v.style.display === 'none' ? 'block' : 'none';
}

initFonts(); loadDir();
</script>
</body>
</html>
